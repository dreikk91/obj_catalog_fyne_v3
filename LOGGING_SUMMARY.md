# 📋 Детальне логування запуску та роботи програми

## Огляд доданого логування

Додано комплексне логування всіх основних етапів запуску та роботи програми АРМ Пожежної Безпеки. Логування охоплює всі критичні операції та повинно допомогти в діагностиці проблем.

---

## 📊 Етапи логування, що охоплюють запуск

### 1️⃣ **Етап 1: Ініціалізація логера** (`pkg/logger/logger.go`)

#### Що логується:
- Конфігурація логера (рівень, директорія, налаштування)
- Створення директорій для логів
- Налаштування файлових логерів (app.log, error.log)
- Налаштування консолього логера з красивим форматом
- Рівень логування (DEBUG, INFO, WARNING, ERROR)
- Включення/вимикання sampling'у

#### Приклад логів:
```
📋 Налаштування системи логування...
  📂 Створення директорії логів: ./log
  ✓ Файловий логер налаштовано (app.log)
  ✓ Логер помилок налаштовано (error.log)
  🎨 Увімкнено красивий формат консолі
  ✓ Консолень логер налаштовано
  ⚡ Рівень логування: info
✅ Система логування готова
```

---

### 2️⃣ **Етап 2: Запуск головної програми** (`main.go` - функція `main()`)

#### Що логується:
- **Банер запуску програми**
- Конфігурація логера
- Навантаження програми в пам'ять
- Перехоплення паніки з подробиця інформацією
- **Банер завершення програми**

#### Приклад логів:
```
╔════════════════════════════════════════════════════════════════╗
║   ЗАПУСК ПРОГРАМИ - АРМ ПОЖЕЖНОЇ БЕЗПЕКИ v1.0                  ║
╚════════════════════════════════════════════════════════════════╝
[INFO] Логер налаштований level=info logDir=./log
[DEBUG] Ініціалізація додатку...
[INFO] Додаток ініціалізовано. Запуск UI...
```

---

### 3️⃣ **Етап 3: Завантаження налаштувань БД** (`pkg/config/db_config.go`)

#### Що логується:
- Завантаження налаштувань з преференсів Fyne
- Значення: користувач, хост, порт, шлях до БД
- Запис дефолтних значень при першому запуску
- Формування DSN рядка підключення

#### Приклад логів:
```
[DEBUG] ⚙️  Завантаження налаштувань БД з преференсів...
[DEBUG] ✓ Налаштування БД завантажено user=SYSDBA host=localhost port=3050 path=C:/MOST.PM/BASE/MOST5.FDB
[DEBUG] 💾 Збереження налаштувань БД...
[DEBUG] ✓ Налаштування БД збережено host=localhost port=3050
[DEBUG] 📝 DSN сформовано dsn=SYSDBA:masterkey@localhost:3050/C:/MOST.PM/BASE/MOST5.FDB
```

---

### 4️⃣ **Етап 4: Ініціалізація Fyne** (`main.go` - функція `NewApplication()`)

#### Що логується:
- Створення Fyne додатку з ID
- Створення головного вікна з розмірами
- Встановлення теми (темна/світла)

#### Приклад логів:
```
[INFO] Етап 1️⃣ : Ініціалізація Fyne додатку...
[DEBUG] Fyne додаток створено appID=com.most.obj_catalog_fyne_v3
[DEBUG] Створення головного вікна...
[DEBUG] Головне вікно налаштовано size=1024x768
```

---

### 5️⃣ **Етап 5: Підключення до Firebird БД** (`pkg/database/connect.go`)

#### Що логується:
- **Критичний етап**: Відкриття драйвера БД
- Налаштування пулу з'єднань (макс. активних, неактивних, TTL)
- Перша перевірка з'єднання (ping)
- Помилки підключення

#### Приклад логів:
```
[INFO] 📂 Початок ініціалізації БД Firebird...
[DEBUG] Відкриття драйвера БД...
[DEBUG] ✓ Драйвер відкритий
[DEBUG] Налаштування пулу з'єднань...
[DEBUG] ✓ Пул з'єднань налаштовано maxOpenConns=25 maxIdleConns=5 maxConnLifetime=5m
[DEBUG] Виконання першої перевірки з'єднання (ping)...
[INFO] ✅ З'єднання з БД встановлено успішно
```

**Помилка при підключенні:**
```
[ERROR] ❌ КРИТИЧНА ПОМИЛКА: Не вдалося налаштувати драйвер Firebird error=connection refused
```

---

### 6️⃣ **Етап 6: Моніторинг здоров'я БД** (`pkg/database/connect.go` - функція `StartHealthCheck()`)

#### Що логується:
- Запуск фонового моніторингу (кожні 30 сек)
- Вдалі перевірки (DEBUG)
- **Потенційні проблеми** (WARNING)
- **Багаторазові відмови** (ERROR)
- Відновлення з'єднання після збою

#### Приклад логів:
```
[INFO] 🏥 Запуск моніторингу здоров'я БД (перевірка кожні 30 сек)...
[DEBUG] ✓ Перевірка здоров'я БД - OK checkNumber=1
[WARN] ⚠️  Втрачено зв'язок з Firebird! error=connection reset failCount=1
[ERROR] ❌ БАГАТОРАЗОВІ ВІДМОВИ З'єднання з БД! error=connection reset consecutiveFailures=3
[INFO] ✅ З'єднання з БД відновлено afterFailures=3
```

---

### 7️⃣ **Етап 7: Ініціалізація провайдера даних** (`pkg/data/db_provider.go`)

#### Що логується:
- Створення DBDataProvider
- Логування всіх операцій з даними:
  - **GetObjects()** - загальна кількість об'єктів
  - **GetObjectByID()** - ID, ім'я, статус об'єкта
  - **GetAlarms()** - кількість тривог, деталі кожної
  - **GetEvents()** - кількість нових подій, останній ID
  - **ProcessAlarm()** - обробка тривог

#### Приклад логів:
```
[DEBUG] ✓ DBDataProvider ініціалізовано з підключенням до БД
[DEBUG] 📦 Завантаження списку об'єктів з БД...
[DEBUG] ✓ Список об'єктів завантажено objectsCount=45
[DEBUG] 🔍 Завантаження деталей об'єкта... objectID=15
[DEBUG] ✓ Деталі об'єкта завантажено objectID=15 name=Офіс на вул. Шевченка status=OK
```

**Для тривог:**
```
[DEBUG] 🚨 Завантаження активних тривог з БД...
[DEBUG] ✓ Тривоги завантажено alarmsCount=3
[INFO] ⚠️  АКТИВНІ ТРИВОГИ ЗНАЙДЕНО! count=3
[WARN]   → Тривога id=1 object=Магазин на ст.Мінська address=вул. Мінська, 15
```

**Для подій:**
```
[DEBUG] 📋 Завантаження глобальних подій...
[DEBUG] Перший запуск GetEvents - отримання останнього ID...
[DEBUG] Останній ID подій встановлено lastEventID=5432
[DEBUG] Знайдено нові события newEventsCount=12
[DEBUG] ✓ События завантажено totalCachedEvents=50
```

---

### 8️⃣ **Етап 8: Побудова UI компонентів** (`main.go` - функція `buildUI()`)

#### Що логується:
- Створення кожного компонента:
  - AlarmPanel
  - ObjectListPanel
  - WorkAreaPanel
  - EventLogPanel
- Налаштування callbacks
- Компонування макета
- Взаємодія користувача (вибір об'єктів, тривог, подій)

#### Приклад логів:
```
[INFO] Етап 6️⃣ : Побудова UI компонентів...
[DEBUG] Створення AlarmPanel...
[DEBUG] ✓ AlarmPanel створена
[DEBUG] Створення ObjectListPanel...
[DEBUG] ✓ ObjectListPanel створена
[DEBUG] Налаштування callbacks...
[DEBUG] ✓ Callbacks налаштовані
[DEBUG] Компонування макета...
[DEBUG] ✓ UI побудований та встановлений на вікно
[INFO] ✅ ІНІЦІАЛІЗАЦІЯ ЗАВЕРШЕНА. Програма готова до роботи.
```

---

## 📝 Логування під час роботи програми

### 🎨 Перемикання теми
```
[DEBUG] Перемикання теми... darkTheme=true
[DEBUG] Застосування темної теми...
[DEBUG] Тема застосована darkTheme=true fontSize=12
```

### ⚙️ Зміна налаштувань БД
```
[DEBUG] Відкриття діалогу налаштувань...
[INFO] Параметри в діалозі налаштувань змінено host=192.168.1.100
[WARN] 🔄 Перепідключення до бази даних... dsn=...
[DEBUG] Ініціалізація нового з'єднання з БД...
[DEBUG] ✓ Нове з'єднання з БД успішне
[DEBUG] Закриття старого з'єднання з БД...
[DEBUG] ✓ Старе з'єднання закрито
[DEBUG] Провайдер даних оновлено
[DEBUG] Оновлення посилань на БД у панелях...
[DEBUG] ✓ Посилання оновлено
[DEBUG] Перезавантаження даних у всіх панелях...
[DEBUG] ✓ Дані перезавантажено
[INFO] ✅ Перепідключення до БД завершено успішно
```

### 👆 Взаємодія користувача
```
[DEBUG] Об'єкт вибраний з списку objectID=23 objectName=Магазин ABC
[DEBUG] Тривога вибрана alarmID=1 objectID=15
[DEBUG] Подія вибрана eventID=456 objectID=10
[DEBUG] Початок обробки тривоги... alarmID=1
[INFO] Тривога оброблена alarmID=1 action=Взято на обробку note=Перевірено диспетчером
```

### 🎨 Оновлення UI параметрів
```
[INFO] 🎨 Оновлення параметрів інтерфейсу... fontSize=14
[DEBUG] Нові розміри шрифтів fontSizeAlarms=12 fontSizeObjects=13 fontSizeEvents=11
[DEBUG] Оновлення AlarmPanel...
[DEBUG] Оновлення ObjectListPanel...
[DEBUG] Оновлення WorkAreaPanel...
[DEBUG] Оновлення EventLogPanel...
[INFO] ✅ Параметри інтерфейсу оновлено
```

---

## 📂 Розташування логів

Логи зберігаються у директорії `./log/` :
- **`app.log`** - основний лог всієї програми (з ротацією)
- **`error.log`** - окремий лог тільки для помилок (з ротацією)

### Налаштування ротації:
- **Макс розмір файлу**: 100 MB
- **Кількість архівів**: 10 файлів
- **Строк зберігання**: 30 днів
- **Компресія**: ввімкнена (.gz)

---

## 🎯 Рівні логування

| Рівень | Символ | Використання |
|--------|--------|--------------|
| **DEBUG** | 🔍 | Деталі операцій, потік виконання |
| **INFO** | ℹ️  | Важливі етапи, успішне завершення |
| **WARN** | ⚠️  | Потенційні проблеми, але програма працює |
| **ERROR** | ❌ | Помилки, але програма може продовжити роботу |

---

## 🔍 Як використовувати логи для діагностики

### Проблема: Програма не запускається
1. Перевірте `app.log` на помилки на етапі 1-3
2. Дивіться, чи завантажилися налаштування БД
3. Перевірте, чи успішно підключилася БД на етапі 5

### Проблема: БД часто відпадає
1. Дивіться `app.log` на повідомлення від моніторингу здоров'я
2. Ищите паттерн `⚠️  Втрачено зв'язок` та `❌ БАГАТОРАЗОВІ ВІДМОВИ`
3. Перевірте налаштування мережі та Firebird

### Проблема: Програма віс при завантаженні даних
1. Дивіться на час логування подій GetObjects, GetAlarms, GetEvents
2. Ищите `timeout` помилки в логах
3. Перевірте продуктивність запитів до БД

### Проблема: Невідповідні дані на екрані
1. Перевірте логи обробки вибору об'єктів/тривог
2. Дивіться на логи перезавантаження даних
3. Ищите помилки при оновленні UI компонентів

---

## 📌 Приклад повного запуску програми

```
PS D:\goproject\obj_catalog_fyne_v3> .\app.exe

📋 Налаштування системи логування...
  📂 Створення директорії логів: ./log
  ✓ Файловий логер налаштовано (app.log)
  ✓ Логер помилок налаштовано (error.log)
  🎨 Увімкнено красивий формат консолі
  ✓ Консолень логер налаштовано
  ⚡ Рівень логування: info
✅ Система логування готова

| INFO  | ╔════════════════════════════════════════════════════════════════╗
| INFO  | ║   ЗАПУСК ПРОГРАМИ - АРМ ПОЖЕЖНОЇ БЕЗПЕКИ v1.0                  ║
| INFO  | ╚════════════════════════════════════════════════════════════════╝
| INFO  | Логер налаштований level=info logDir=./log
| DEBUG | Ініціалізація додатку...
| INFO  | Етап 1️⃣ : Ініціалізація Fyne додатку...
| DEBUG | Fyne додаток створено appID=com.most.obj_catalog_fyne_v3
| DEBUG | Створення головного вікна...
| DEBUG | Головне вікно налаштовано size=1024x768
| INFO  | Етап 2️⃣ : Завантаження налаштувань БД...
| DEBUG | ⚙️  Завантаження налаштувань БД з преференсів...
| DEBUG | ✓ Налаштування БД завантажено
| INFO  | Етап 3️⃣ : Підключення до бази даних...
| INFO  | 📂 Початок ініціалізації БД Firebird...
| DEBUG | Відкриття драйвера БД...
| DEBUG | ✓ Драйвер відкритий
| DEBUG | Налаштування пулу з'єднань...
| DEBUG | ✓ Пул з'єднань налаштовано
| DEBUG | Виконання першої перевірки з'єднання (ping)...
| INFO  | ✅ З'єднання з БД встановлено успішно
| INFO  | БД підключена, запуск перевірки здоров'я...
| INFO  | 🏥 Запуск моніторингу здоров'я БД (перевірка кожні 30 сек)...
| INFO  | Етап 4️⃣ : Ініціалізація провайдера даних...
| DEBUG | ✓ DBDataProvider ініціалізовано
| INFO  | Етап 5️⃣ : Створення структури додатку...
| DEBUG | Структура додатку готова
| INFO  | Етап 6️⃣ : Побудова UI компонентів...
| DEBUG | Початок побудови UI компонентів...
| DEBUG | Створення AlarmPanel...
| INFO  | ✅ ІНІЦІАЛІЗАЦІЯ ЗАВЕРШЕНА. Програма готова до роботи.
```

---

## 📞 Технічні деталі

### Використані бібліотеки
- **zerolog** - високопродуктивний JSON-логер
- **lumberjack** - ротація логів за розміром
- **pkgerrors** - stack trace логування

### Формат логів
```
| LEVEL | TIME         | MESSAGE                                          | FIELDS...
| INFO  | 15:04:05     | З'єднання з БД встановлено успішно               | 
| DEBUG | 15:04:05     | ✓ DBDataProvider ініціалізовано                  | host=localhost port=3050
```

---

**Документ створено: 05.02.2026**
**Версія програми: v1.0**
